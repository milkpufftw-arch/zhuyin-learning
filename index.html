<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ³¨éŸ³å­¸ç¿’åœ–æ–‡ç‰ˆ</title>
    <style>
        /* --- CSS æ¨£å¼å€åŸŸ --- */
        
        :root {
            --primary-color: #FF9A9E;
            --secondary-color: #FECFEF;
            --accent-color: #a18cd1;
            --bg-color: #fbc2eb;
            --bg-color-2: #a6c1ee;
            --canvas-bg: rgba(255, 255, 255, 0.7);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-image: linear-gradient(120deg, var(--bg-color) 0%, var(--bg-color-2) 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            touch-action: none;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            padding: 15px 20px;
            width: 90%;
            max-width: 420px; /* ç¨å¾®åŠ å¯¬ */
            text-align: center;
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            height: 90vh; /* è®“å¡ç‰‡é©æ‡‰é«˜åº¦ */
            max-height: 700px;
            justify-content: space-between;
        }

        h1 {
            color: var(--accent-color);
            margin: 5px 0;
            font-size: 1.2rem;
        }

        /* é€²åº¦æ¢ */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #eee;
            border-radius: 3px;
            margin-bottom: 5px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #4facfe;
            width: 0%;
            transition: width 0.3s ease;
        }

        .top-controls {
            position: absolute;
            top: 15px;
            right: 15px;
        }

        .btn-speak {
            background-color: #ffcc00;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .btn-speak:active { transform: scale(0.9); }

        /* --- åœ–ç‰‡èˆ‡æ–‡å­—å€ --- */
        .visual-area {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 5px;
            background: #f0f4f8;
            border-radius: 15px;
            padding: 10px;
        }

        .visual-icon {
            font-size: 3.5rem; /* Emoji å¤§å° */
            line-height: 1;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1));
        }

        .word-hint {
            font-size: 1.5rem;
            color: #333;
            font-weight: bold;
        }
        
        .word-sub {
            font-size: 1rem;
            color: var(--accent-color);
        }

        /* --- ç¹ªåœ–å€ --- */
        .display-area {
            position: relative;
            width: 260px; /* å›ºå®šå¯¬åº¦ */
            height: 260px; /* å›ºå®šé«˜åº¦ */
            margin: 0 auto;
            border: 4px dashed var(--accent-color);
            border-radius: 20px;
            background-color: var(--canvas-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
        }

        .char-background {
            position: absolute;
            font-size: 180px;
            font-weight: bold;
            color: #e0e0e0;
            pointer-events: none;
            user-select: none;
            z-index: 1;
            font-family: "BiauKai", "DFKai-SB", serif;
        }

        canvas {
            position: absolute;
            top: 0; left: 0; z-index: 2;
            cursor: crosshair;
            touch-action: none;
        }

        /* --- æ§åˆ¶æŒ‰éˆ• --- */
        .controls {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            gap: 10px;
        }

        .btn {
            border: none;
            border-radius: 15px;
            padding: 10px 0;
            font-size: 1rem;
            cursor: pointer;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            flex: 1;
        }

        .btn:active { transform: scale(0.95); }
        .btn-nav { background-color: #4facfe; }
        .btn-clear { background-color: #ff9a9e; flex: 0.8;} /* ä¸­é–“æŒ‰éˆ•ç¨å¾®å°ä¸€é» */
        
        .btn-mic { 
            background-color: #43e97b;
            width: 100%;
            justify-content: center;
            padding: 15px;
            font-size: 1.2rem;
            border-radius: 50px;
            margin-bottom: 5px;
        }
        .btn-mic.listening {
            background-color: #ff6b6b;
            animation: pulse 1.5s infinite;
        }

        #message {
            min-height: 1.5em;
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }

        #confetti-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 999;
        }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div class="card">
        <div class="top-controls">
            <button class="btn-speak" onclick="speakCurrentChar()" title="ç™¼éŸ³">ğŸ”ˆ</button>
        </div>

        <h1>ã„…ã„†ã„‡ å¿«æ¨‚å­¸</h1>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <!-- åœ–ç‰‡èˆ‡æ–‡å­—å¡ç‰‡å€ -->
        <div class="visual-area">
            <div class="visual-icon" id="visualIcon">ğŸ‘¨ğŸ»</div>
            <div style="text-align: left;">
                <div class="word-hint" id="wordHint">çˆ¸çˆ¸</div>
                <div class="word-sub" id="wordSub">ã„…</div>
            </div>
        </div>

        <!-- ç¹ªåœ–å€ -->
        <div class="display-area">
            <div class="char-background" id="charDisplay">ã„…</div>
            <canvas id="drawingCanvas" width="260" height="260"></canvas>
        </div>

        <div id="message"></div>

        <div class="controls">
            <button class="btn btn-nav" onclick="prevChar()">â¬…ï¸ ä¸Šä¸€å€‹</button>
            <button class="btn btn-clear" onclick="clearCanvas()">ğŸ§¹ é‡å¯«</button>
            <button class="btn btn-nav" onclick="nextChar()">ä¸‹ä¸€å€‹ â¡ï¸</button>
        </div>

        <button class="btn btn-mic" id="micBtn" onclick="toggleSpeech()">
            ğŸ¤ å¿µçµ¦æˆ‘è½
        </button>
    </div>

    <script>
        // --- 1. è³‡æ–™åº« (å« Emoji åœ–ç‰‡) ---
        // icon: ä½¿ç”¨ Emoji ä»£è¡¨è©²è©èªçš„åœ–ç‰‡
        const zhuyinData = [
            // è²æ¯
            { symbol: 'ã„…', icon: 'ğŸ‘¨ğŸ»', words: ['çˆ¸çˆ¸', 'åŒ…å­', 'æ¯å­', 'ç­†', 'å…«'] },
            { symbol: 'ã„†', icon: 'ğŸ‡', words: ['è‘¡è„', 'æœ‹å‹', 'è˜‹æœ', 'è·‘æ­¥', 'å©†å©†'] },
            { symbol: 'ã„‡', icon: 'ğŸ‘©ğŸ»', words: ['åª½åª½', 'è²“å’ª', 'é–€', 'éºµåŒ…', 'é¦¬'] },
            { symbol: 'ã„ˆ', icon: 'âœˆï¸', words: ['é£›æ©Ÿ', 'æˆ¿å­', 'é£¯', 'èœ‚èœœ', 'é¢¨'] },
            { symbol: 'ã„‰', icon: 'ğŸ°', words: ['è›‹ç³•', 'å¼Ÿå¼Ÿ', 'å¤§è±¡', 'åˆ€å­', 'è±†æ¼¿'] },
            { symbol: 'ã„Š', icon: 'ğŸ°', words: ['å…”å­', 'å¤ªé™½', 'ç³–æœ', 'å¤©ç©º', 'è¸¢çƒ'] },
            { symbol: 'ã„‹', icon: 'ğŸ¥›', words: ['ç‰›å¥¶', 'å¥¶å¥¶', 'é³¥', 'å—ç“œ', 'æ³¥åœŸ'] },
            { symbol: 'ã„Œ', icon: 'ğŸ¯', words: ['è€è™', 'æ¢¨å­', 'è—è‰²', 'è·¯', 'è€å¸«'] },
            { symbol: 'ã„', icon: 'ğŸ¶', words: ['ç‹—', 'å“¥å“¥', 'å…¬è»Š', 'é«˜', 'éª¨é ­'] },
            { symbol: 'ã„', icon: 'ğŸ¦–', words: ['æé¾', 'å¡ç‰‡', 'è¤²å­', 'è€ƒè©¦', 'å¿«æ¨‚'] },
            { symbol: 'ã„', icon: 'ğŸ’', words: ['çŒ´å­', 'è´è¶', 'èŠ±', 'æµ·è±š', 'å–æ°´'] },
            { symbol: 'ã„', icon: 'ğŸ”', words: ['é›', 'å®¶', 'ç©æœ¨', 'æ©Ÿå™¨äºº', 'æ©˜å­'] },
            { symbol: 'ã„‘', icon: 'ğŸˆ', words: ['æ°£çƒ', 'ä¼éµ', 'æ±½è»Š', 'è£™å­', 'é’è›™'] },
            { symbol: 'ã„’', icon: 'ğŸ‰', words: ['è¥¿ç“œ', 'æ˜Ÿæ˜Ÿ', 'æ´—æ‰‹', 'é¦™è•‰', 'å°ç‹—'] },
            { symbol: 'ã„“', icon: 'ğŸ•·ï¸', words: ['èœ˜è››', 'æ¡Œå­', 'è±¬', 'çç å¥¶èŒ¶', 'ç´™'] },
            { symbol: 'ã„”', icon: 'ğŸ¦’', words: ['é•·é ¸é¹¿', 'åƒé£¯', 'è»Šå­', 'å¹é¢¨æ©Ÿ', 'èŒ¶'] },
            { symbol: 'ã„•', icon: 'ğŸ¦', words: ['ç…å­', 'æ‰‹', 'æ›¸', 'æ¨¹', 'æ°´'] },
            { symbol: 'ã„–', icon: 'ğŸ“…', words: ['æ—¥æ›†', 'ç†±', 'äºº', 'è‚‰', 'æ—¥è¨˜'] },
            { symbol: 'ã„—', icon: 'ğŸš¶', words: ['èµ°è·¯', 'æ—©ä¸Š', 'ç´«è‰²', 'å˜´å·´', 'å†è¦‹'] },
            { symbol: 'ã„˜', icon: 'ğŸ“', words: ['è‰è“', 'å»æ‰€', 'èœ', 'æ“¦å­', 'å½©è™¹'] },
            { symbol: 'ã„™', icon: 'â˜‚ï¸', words: ['é›¨å‚˜', 'ä¸‰', 'æ£®æ—', 'æ¾é¼ ', 'å››'] }, // å‚˜å«ã„™éŸ³
            
            // éŸ»æ¯ & çµåˆéŸ»
            { symbol: 'ã„§', icon: 'ğŸ‘•', words: ['è¡£æœ', 'æ¤…å­', 'ä¸€', 'é†«ç”Ÿ', 'çˆºçˆº'] },
            { symbol: 'ã„¨', icon: 'ğŸ¢', words: ['çƒé¾œ', 'äº”', 'å±‹å­', 'è¥ªå­', 'èšŠå­'] },
            { symbol: 'ã„©', icon: 'ğŸŸ', words: ['é­š', 'ç‰ç±³', 'é›¨', 'æœˆäº®', 'æµ´å®¤'] },
            { symbol: 'ã„š', icon: 'ğŸ¦†', words: ['é´¨å­', 'ç‰™é½’', 'é˜¿å§¨', 'è Ÿç­†', 'é’è›™'] },
            { symbol: 'ã„›', icon: 'ğŸ”¥', words: ['ç«', 'æˆ‘', 'å–”', 'æ³¢æµª', 'è˜¿è””'] },
            { symbol: 'ã„œ', icon: 'ğŸ¦¢', words: ['éµ', 'è»Šå­', 'æƒ¡é­š', 'è‚šå­', 'å“¥å“¥'] },
            { symbol: 'ã„', icon: 'ğŸ‘Ÿ', words: ['é‹å­', 'çˆºçˆº', 'è‘‰å­', 'å§å§', 'è´è¶'] },
            { symbol: 'ã„', icon: 'â¤ï¸', words: ['æ„›å¿ƒ', 'æµ·è±š', 'ç™½è‰²', 'å¥¶å¥¶', 'å¯æ„›'] },
            { symbol: 'ã„Ÿ', icon: 'ğŸ¥¤', words: ['æ¯å­', 'é£›æ©Ÿ', 'å¦¹', 'åŒ—æ¥µç†Š', 'é»‘è‰²'] },
            { symbol: 'ã„ ', icon: 'ğŸ±', words: ['è²“å’ª', 'è›‹ç³•', 'è‰è“', 'æ¡ƒå­', 'æ›¸åŒ…'] },
            { symbol: 'ã„¡', icon: 'âœ‹', words: ['æ‰‹', 'çŒ´å­', 'ç‹—', 'çƒ', 'æµ·é·—'] },
            { symbol: 'ã„¢', icon: 'â›°ï¸', words: ['å±±', 'é›¨å‚˜', 'é›è›‹', 'é£¯', 'è—è‰²'] },
            { symbol: 'ã„£', icon: 'ğŸšª', words: ['é–€', 'äºº', 'é›²', 'è£™å­', 'æ„Ÿè¬'] },
            { symbol: 'ã„¤', icon: 'ğŸ¬', words: ['ç³–æœ', 'æ¹¯åŒ™', 'å¤ªé™½', 'åºŠ', 'å¤§è±¡'] },
            { symbol: 'ã„¥', icon: 'ğŸ', words: ['èœœèœ‚', 'é¢¨', 'ç‡ˆç± ', 'å½©è™¹', 'æ™‚é˜'] },
            { symbol: 'ã„¦', icon: 'ğŸ‘‚', words: ['è€³æœµ', 'äºŒ', 'å…’å­', 'è€Œä¸”', 'å…’ç«¥'] }
        ];

        let currentIndex = 0;

        // DOM å…ƒç´ 
        const charDisplay = document.getElementById('charDisplay');
        const visualIcon = document.getElementById('visualIcon');
        const wordHint = document.getElementById('wordHint');
        const wordSub = document.getElementById('wordSub');
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const messageDiv = document.getElementById('message');
        const micBtn = document.getElementById('micBtn');
        const progressFill = document.getElementById('progressFill');

        function init() {
            updateDisplay(false); 
            setupCanvas();
        }

        function updateDisplay(autoSpeak = true) {
            const data = zhuyinData[currentIndex];
            
            // æ›´æ–° UI
            charDisplay.textContent = data.symbol;
            visualIcon.textContent = data.icon; // æ›´æ–°åœ–ç‰‡ (Emoji)
            wordHint.textContent = data.words[0]; // é¡¯ç¤ºç¬¬ä¸€å€‹è©ï¼šçˆ¸çˆ¸
            wordSub.textContent = data.symbol;    // é¡¯ç¤ºå°æ³¨éŸ³ï¼šã„…
            
            messageDiv.textContent = "";
            clearCanvas();
            
            // æ›´æ–°é€²åº¦æ¢
            const percent = ((currentIndex + 1) / zhuyinData.length) * 100;
            progressFill.style.width = `${percent}%`;
            
            if(autoSpeak) {
                setTimeout(speakCurrentChar, 400);
            }
        }

        function prevChar() {
            if (currentIndex > 0) {
                currentIndex--;
                updateDisplay(true);
            }
        }

        function nextChar() {
            if (currentIndex < zhuyinData.length - 1) {
                currentIndex++;
                updateDisplay(true);
            }
        }

        // --- TTS ç™¼éŸ³ ---
        function speakCurrentChar() {
            const data = zhuyinData[currentIndex];
            // æœ—è®€ï¼šã„…... çˆ¸çˆ¸
            const textToSpeak = `${data.symbol}ã€‚${data.words[0]}`;
            
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'zh-TW';
            utterance.rate = 0.8; 
            utterance.pitch = 1.1;
            window.speechSynthesis.speak(utterance);
        }

        // --- Canvas ç¹ªåœ– ---
        let isDrawing = false;
        function setupCanvas() {
            ctx.lineWidth = 15;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#FF5252';

            const start = (e) => {
                isDrawing = true;
                e.preventDefault(); 
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
            };
            const move = (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const pos = getPos(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            };
            const end = () => { if(isDrawing) { ctx.closePath(); isDrawing = false; } };

            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', move);
            canvas.addEventListener('mouseup', end);
            canvas.addEventListener('mouseout', end);

            canvas.addEventListener('touchstart', start, {passive: false});
            canvas.addEventListener('touchmove', move, {passive: false});
            canvas.addEventListener('touchend', end);
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // --- èªéŸ³è¾¨è­˜ ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isListening = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-TW';
            recognition.interimResults = false;

            recognition.onstart = () => {
                isListening = true;
                micBtn.classList.add('listening');
                micBtn.textContent = "ğŸ‘‚ è†è½ä¸­...";
                messageDiv.textContent = "";
            };

            recognition.onend = () => {
                isListening = false;
                micBtn.classList.remove('listening');
                micBtn.textContent = "ğŸ¤ å¿µçµ¦æˆ‘è½";
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                checkPronunciation(transcript);
            };
            
            recognition.onerror = () => {
                messageDiv.textContent = "è½ä¸æ¸…æ¥šï¼Œå†å¤§è²ä¸€é»ï½";
            };
        } else {
            micBtn.style.display = 'none';
        }

        function toggleSpeech() {
            if (!recognition) return;
            if (isListening) recognition.stop();
            else recognition.start();
        }

        function checkPronunciation(input) {
            const currentData = zhuyinData[currentIndex];
            let isCorrect = false;
            
            if (input.includes(currentData.symbol)) isCorrect = true;
            for (let word of currentData.words) {
                if (input.includes(word)) { isCorrect = true; break; }
            }

            if (isCorrect) {
                messageDiv.textContent = `ç­”å°äº†ï¼æ˜¯ã€Œ${currentData.words[0]}ã€ğŸ‰`;
                messageDiv.style.color = "green";
                triggerConfetti();
                // èªéŸ³çå‹µ
                const utterance = new SpeechSynthesisUtterance("ä½ å¥½æ£’ï¼");
                utterance.lang = 'zh-TW';
                utterance.rate = 1.2;
                window.speechSynthesis.speak(utterance);
            } else {
                messageDiv.textContent = `å¥½åƒä¸æ˜¯ã€Œ${input}ã€å–”ï¼Œå†è©¦ä¸€æ¬¡ï¼`;
                messageDiv.style.color = "#FF5252";
            }
        }

        // --- ç…™ç«ç‰¹æ•ˆ ---
        const confettiCanvas = document.getElementById('confetti-canvas');
        const confettiCtx = confettiCanvas.getContext('2d');
        let particles = [];

        window.addEventListener('resize', () => {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
        });
        confettiCanvas.width = window.innerWidth;
        confettiCanvas.height = window.innerHeight;

        function triggerConfetti() {
            particles = [];
            for (let i = 0; i < 80; i++) {
                particles.push({
                    x: window.innerWidth / 2,
                    y: window.innerHeight / 2,
                    vx: (Math.random() - 0.5) * 15,
                    vy: (Math.random() - 0.5) * 15 - 5,
                    color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                    size: Math.random() * 8 + 4,
                    gravity: 0.4
                });
            }
            animateConfetti();
        }

        function animateConfetti() {
            if (particles.length === 0) return;
            confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            for (let i = 0; i < particles.length; i++) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vy += p.gravity;
                confettiCtx.fillStyle = p.color;
                confettiCtx.fillRect(p.x, p.y, p.size, p.size);
                if (p.y > window.innerHeight) {
                    particles.splice(i, 1);
                    i--;
                }
            }
            requestAnimationFrame(animateConfetti);
        }

        init();
    </script>
</body>
</html>